\newsavebox{\sw}
\begin{lrbox}{\sw}
\begin{lstlisting}[style=agree,numbers=left]
eq req : bool = event(AutomationRequest);*\label{line:sw-event-def-start}*
eq avl : bool = event(AirVehicleLocation);
eq wp  : bool = event(Waypoint);
eq strt: bool = event(Start);
eq alrt: bool = event(Alert);*\label{line:sw-event-def-end}*

assume "Automation requests are well-formed" : *\label{line:sw-assume-1}*
  req => WELL_FORMED_AUTOMATION_REQUEST(AutomationRequest);
assume "Air vehicle locations are well-formed" : *\label{line:sw-assume-2}*
  avl => WELL_FORMED_WAYPOINT(AirVehicleLocation);
assume "One automation request in flight at a time" : *\label{line:sw-assume-3}*
  true ->
  (req => pre(Historically(not req) or Since(not req, strt)));

guarantee "Waypoints coincide with air vehicle locations": *\label{line:sw-guarantee-1}*
  wp => avl;
guarantee "Starts include a new waypoint" : *\label{line:sw-guarantee-2}*
  strt => wp;
guarantee "Waypoints are well-formed" :  *\label{line:sw-guarantee-3}*
  wp => WELL_FORMED_WAYPOINT(Waypoint);
guarantee "Starts within one cycle of requests if not alerting" : *\label{line:sw-guarantee-4}*
  (strt => ((not alrt) and req)) ->
  (strt => ((not alrt) and (req or pre(req))));
guarantee "Alert if not started within one cycle of requests" : *\label{line:sw-guarantee-5}*
  true -> ((pre(req and not strt) and not strt) => alrt);
guarantee "Once alerted always alerted" : *\label{line:sw-guarantee-6}*
  Once(alrt) => alrt;
\end{lstlisting}
\end{lrbox}

\begin{figure}
  \begin{center}
    \scalebox{0.62}{\usebox{\sw}}
  \end{center}
  \caption{The SW component contract.}
  \label{fig:sw}
\end{figure}

The actual surface syntax for AGREE that is embedded in OSATE is slightly different than the formal semantics in the previous section.
The mapping between the two is straightforward.
The AGREE specification for the SW component in the example of
Section~\ref{sec:example} is given in \figref{fig:sw}.  The
specification uses \texttt{eq} statements to define variables local to
the contract specification.  For
example, \lineref{line:sw-event-def-start} defines the \texttt{req}
variable to be equivalent to the \texttt{event} expression.

All the named ports in the corresponding AADL component are in the scope of the specification, and there are additional implicit boolean \emph{event} inputs (or outputs) associated with event ports.
An \texttt{event} expression refers to that implicit input (or output) boolean value and is true when data is present on the named port and false otherwise.
\linesref{line:sw-event-def-start}{line:sw-event-def-end} create local variables that are true when data is present on the corresponding event ports for the component.
The local variables here are purely for convenience in writing the specification.

The \texttt{assume} statement is a string description followed by a predicate.
Those on \lineref{line:sw-assume-1} and \lineref{line:sw-assume-2} are implications requiring that when data is present it is well-formed.
The well-formed predicates themselves are defined elsewhere using AGREE functions.

The assumption on \lineref{line:sw-assume-3} constrains when a request can arrive by reasoning about the \emph{state} of the contract defined be the associated streams.
When writing assumptions and guarantees, it is important to differentiate pre-state, before a contract updates its state, and post-state, after a contract updates its state, in response to the current input.
The \texttt{pre} naturally makes that distinction.
In general, assumptions regarding state should be evaluated in the pre-state of the component with the current inputs, and guarantees regarding state should be evaluated on the post-state of the component given the current inputs.
Additionally, guarantees should use \texttt{pre} anytime they need to reason about the current state relative to the previous state.

The assumption on \lineref{line:sw-assume-3} uses a followed-by expression so it is \texttt{true} at time zero and then it is the truth value of the implication in all future instances.
The followed-by guards the \texttt{pre} as mentioned previously;
thus after time zero, the assumption depends on the presence of a request and the pre-state of the component.
The assumption on \lineref{line:sw-assume-3} is that if there is an incoming request, it is either the very first one, \texttt{\textbf{Historically}(\textbf{not} req)}, or it is after the component has output a start event in response to a previous request, \texttt{\textbf{Since}(\textbf{not} req, strt)}---\emph{not request since start}.

The guarantees on \linesref{line:sw-guarantee-1}{line:sw-guarantee-3} coincide events and assert well-formed output.
The guarantees on \linesref{line:sw-guarantee-4}{line:sw-guarantee-6} define temporal properties of the component.
\lineref{line:sw-guarantee-4} insists that a start happens with a request or one step after a request.
The guarantee uses the assumption on \lineref{line:sw-assume-3} and does not check for two requests in a row without a start as the assumption precludes that input behavior.
It differentiates with the followed-by what is required at time zero, the start must coincide with the request, with what is required after time zero, the start must coincide with the request or is a response to a request one step earlier.
The guarantee also does not force the start to always happen, it only says that if it does happen, it is under the defined conditions.

\lineref{line:sw-guarantee-5} forces the alert to sound if the start does not arrive within the one-step bound.
Together with \lineref{line:sw-guarantee-4} the contract model allows for non-alerting and alerting behavior.
\lineref{line:sw-guarantee-6} ensures if alert has ever happened, then it is happening in the present moment.
These six guarantees define the behavior of the SW component under the three assumptions and correspond to the informal descriptions given in \secref{sec:example}.